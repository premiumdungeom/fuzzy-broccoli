<html lang="en" class="dark" style="--tg-viewport-height: 100vh; --tg-viewport-stable-height: 100vh;">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="icon" type="image/svg+xml" href="/favicon.svg">
  <link rel="icon" type="image/x-icon" href="/favicon.ico">
  <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
  <link rel="manifest" href="/site.webmanifest">
  <meta name="theme-color" content="#0c0a09">
  <title>AdHive</title>
  <style>
    /* Base styles */
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }
    
    body {
      background-color: #0c0a09;
      color: white;
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
      line-height: 1.5;
    }
    
    .container {
      max-width: 400px;
      margin: 0 auto;
      padding: 20px;
    }
    
    .card {
      background-color: #18181b;
      border-radius: 12px;
      border: 1px solid #3f3f46;
      overflow: hidden;
    }
    
    .card-header {
      padding: 24px;
      text-align: center;
      border-bottom: 1px solid #3f3f46;
    }
    
    .card-title {
      font-size: 1.5rem;
      font-weight: 600;
      color: #60a5fa;
      margin-bottom: 8px;
    }
    
    .card-subtitle {
      color: #a1a1aa;
      font-size: 0.875rem;
    }
    
    .card-body {
      padding: 24px;
    }
    
    .channel-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 16px;
      background-color: #27272a;
      border-radius: 8px;
      margin-bottom: 12px;
    }
    
    .channel-name {
      font-weight: 500;
    }
    
    .btn {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      border-radius: 6px;
      font-weight: 500;
      font-size: 0.875rem;
      padding: 8px 16px;
      cursor: pointer;
      border: 1px solid transparent;
      transition: all 0.2s;
    }
    
    .btn-primary {
      background-color: #2563eb;
      color: white;
    }
    
    .btn-primary:hover {
      background-color: #1d4ed8;
    }
    
    .btn-secondary {
      background-color: #3f3f46;
      color: white;
      border-color: #52525b;
    }
    
    .btn-secondary:hover {
      background-color: #52525b;
    }
    
    .btn-success {
      background-color: #16a34a;
      color: white;
    }
    
    .btn-success:hover {
      background-color: #15803d;
    }
    
    .btn:disabled {
      opacity: 0.6;
      cursor: not-allowed;
    }
    
    .action-button {
      width: 100%;
      padding: 12px;
      font-size: 1rem;
      margin-top: 16px;
    }
    
    .user-info {
      background-color: #3f3f46;
      padding: 12px 16px;
      border-radius: 8px;
      margin-bottom: 16px;
      font-size: 0.875rem;
    }
    
    .status-badge {
      display: inline-block;
      padding: 4px 8px;
      border-radius: 4px;
      font-size: 0.75rem;
      font-weight: 500;
      margin-left: 8px;
    }
    
    .status-joined {
      background-color: #166534;
      color: #dcfce7;
    }
    
    .status-pending {
      background-color: #9a3412;
      color: #fed7aa;
    }
    
    .modal {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background-color: rgba(0, 0, 0, 0.8);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 100;
      padding: 20px;
    }
    
    .modal-content {
      background-color: #18181b;
      border-radius: 12px;
      padding: 24px;
      max-width: 400px;
      width: 100%;
      text-align: center;
    }
    
    .modal-title {
      font-size: 1.25rem;
      font-weight: 600;
      margin-bottom: 16px;
    }
    
    .modal-message {
      margin-bottom: 24px;
      color: #a1a1aa;
    }
    
    .hidden {
      display: none;
    }
    
    .loader {
      width: 20px;
      height: 20px;
      border: 2px solid #3f3f46;
      border-top: 2px solid #60a5fa;
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin-right: 8px;
    }
    
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="card">
      <div class="card-header">
        <h1 class="card-title">Join Our Channels</h1>
        <p class="card-subtitle">Please join both channels to access exclusive content</p>
      </div>
      
      <div class="card-body">
        <div id="userInfo" class="user-info hidden">
          <!-- User info will be inserted here -->
        </div>
        
        <div class="channel-list">
          <div class="channel-item">
            <span class="channel-name">Channel 1</span>
            <button class="btn btn-secondary join-btn" data-channel="Channel 1">Join</button>
          </div>
          
          <div class="channel-item">
            <span class="channel-name">Channel 2</span>
            <button class="btn btn-secondary join-btn" data-channel="Channel 2">Join</button>
          </div>
        </div>
        
        <button id="verifyButton" class="btn btn-primary action-button">
          Verify Membership
        </button>
      </div>
    </div>
  </div>
  
  <!-- Success Modal -->
  <div id="successModal" class="modal hidden">
    <div class="modal-content">
      <h2 class="modal-title">Success!</h2>
      <p class="modal-message">You've successfully joined all required channels.</p>
      <button class="btn btn-primary" onclick="closeModal('successModal')">Continue</button>
    </div>
  </div>
  
  <!-- Error Modal -->
  <div id="errorModal" class="modal hidden">
    <div class="modal-content">
      <h2 class="modal-title">Attention Required</h2>
      <p id="errorMessage" class="modal-message">Please join all channels to proceed.</p>
      <button class="btn btn-primary" onclick="closeModal('errorModal')">OK</button>
    </div>
  </div>
  
  <!-- Loading Modal -->
  <div id="loadingModal" class="modal hidden">
    <div class="modal-content">
      <h2 class="modal-title">Checking Membership</h2>
      <p class="modal-message">Please wait while we verify your channel memberships...</p>
      <div class="loader" style="margin: 0 auto;"></div>
    </div>
  </div>

  <script>
    // Global state
    let userData = null;
    let channelMembership = {
      'Channel 1': false,
      'Channel 2': false
    };
    
    // DOM elements
    const userInfoEl = document.getElementById('userInfo');
    const joinButtons = document.querySelectorAll('.join-btn');
    const verifyButton = document.getElementById('verifyButton');
    const successModal = document.getElementById('successModal');
    const errorModal = document.getElementById('errorModal');
    const errorMessageEl = document.getElementById('errorMessage');
    const loadingModal = document.getElementById('loadingModal');
    
    // Initialize the app
    document.addEventListener('DOMContentLoaded', function() {
      // Check if we're in Telegram Mini App
      if (window.Telegram && window.Telegram.WebApp) {
        initTelegramWebApp();
      } else {
        // Regular web flow - check if user is already logged in
        const savedUserData = localStorage.getItem('telegramUser');
        if (savedUserData) {
          userData = JSON.parse(savedUserData);
          updateUI();
        }
      }
      
      // Set up event listeners
      joinButtons.forEach(btn => {
        btn.addEventListener('click', function() {
          const channelName = this.getAttribute('data-channel');
          openChannel(channelName);
        });
      });
      
      verifyButton.addEventListener('click', verifyMembership);
    });
    
    // Initialize Telegram Web App
    function initTelegramWebApp() {
      const webApp = window.Telegram.WebApp;
      
      // Expand the app to full height
      webApp.expand();
      
      // Get user data from Telegram
      const tgUser = webApp.initDataUnsafe.user;
      if (tgUser) {
        userData = {
          id: tgUser.id,
          username: tgUser.username,
          firstName: tgUser.first_name,
          lastName: tgUser.last_name || '',
          photoUrl: tgUser.photo_url || null
        };
        
        // Save user data
        localStorage.setItem('telegramUser', JSON.stringify(userData));
        
        // Update UI with user info
        updateUI();
        
        // Check membership status
        checkAllMemberships();
      }
    }
    
    // Open channel in Telegram
    function openChannel(channelName) {
      const channelMap = {
        'Channel 1': 'allinonepayout',
        'Channel 2': 'ALL1N_0NE'
      };
      
      const channelUsername = channelMap[channelName];
      if (channelUsername) {
        // Open in Telegram if in Mini App, otherwise open in new tab
        if (window.Telegram && window.Telegram.WebApp) {
          window.Telegram.WebApp.openTelegramLink(`https://t.me/${channelUsername}`);
        } else {
          window.open(`https://t.me/${channelUsername}`, '_blank');
        }
      }
    }
    
    // Verify membership in all channels
    async function verifyMembership() {
      showModal('loadingModal');
      
      try {
        await checkAllMemberships();
        
        // Check if user has joined all channels
        const allJoined = Object.values(channelMembership).every(status => status);
        
        if (allJoined) {
          // Success - user has joined all channels
          hideModal('loadingModal');
          showModal('successModal');
        } else {
          // Not all channels joined
          hideModal('loadingModal');
          showError('Please join all channels to proceed.');
        }
      } catch (error) {
        console.error('Error verifying membership:', error);
        hideModal('loadingModal');
        showError('An error occurred while verifying your membership. Please try again.');
      }
    }
    
    // Check membership for all channels
    async function checkAllMemberships() {
      if (!userData) {
        // If not logged in, try to initiate login
        if (window.Telegram && window.Telegram.WebApp) {
          // In Mini App, we should already have user data
          return;
        } else {
          // Regular web flow - initiate Telegram login
          await initiateTelegramLogin();
          return;
        }
      }
      
      try {
        const response = await fetch('/api/telegram/check-membership', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({
            userId: userData.id,
            channelNames: ['Channel 1', 'Channel 2']
          })
        });
        
        if (response.ok) {
          const data = await response.json();
          
          // Update membership status
          channelMembership['Channel 1'] = data.membership['Channel 1'] || false;
          channelMembership['Channel 2'] = data.membership['Channel 2'] || false;
          
          // Update UI to reflect membership status
          updateChannelButtons();
        } else {
          console.error('Failed to check membership status');
        }
      } catch (error) {
        console.error('Error checking membership:', error);
      }
    }
    
    // Update channel buttons based on membership status
    function updateChannelButtons() {
      joinButtons.forEach(btn => {
        const channelName = btn.getAttribute('data-channel');
        if (channelMembership[channelName]) {
          btn.textContent = 'Joined';
          btn.classList.remove('btn-secondary');
          btn.classList.add('btn-success');
          btn.disabled = true;
        } else {
          btn.textContent = 'Join';
          btn.classList.remove('btn-success');
          btn.classList.add('btn-secondary');
          btn.disabled = false;
        }
      });
    }
    
    // Update UI with user info
    function updateUI() {
      if (userData) {
        const displayName = `${userData.firstName} ${userData.lastName || ''}`.trim();
        const username = userData.username ? `@${userData.username}` : 'No username';
        
        userInfoEl.innerHTML = `
          <div>Logged in as: <strong>${displayName}</strong> (${username})</div>
        `;
        userInfoEl.classList.remove('hidden');
        
        // Check membership status
        checkAllMemberships();
      }
    }
    
    // Show modal
    function showModal(modalId) {
      document.getElementById(modalId).classList.remove('hidden');
    }
    
    // Hide modal
    function hideModal(modalId) {
      document.getElementById(modalId).classList.add('hidden');
    }
    
    // Close modal
    function closeModal(modalId) {
      hideModal(modalId);
    }
    
    // Show error message
    function showError(message) {
      errorMessageEl.textContent = message;
      showModal('errorModal');
    }
    
    // Regular web flow - initiate Telegram login
    async function initiateTelegramLogin() {
      try {
        const response = await fetch('/api/telegram/login', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          }
        });
        
        if (response.ok) {
          const data = await response.json();
          
          // Open Telegram with the login link
          window.open(data.loginUrl, '_blank');
          
          // Poll for login status
          checkLoginStatus(data.token);
        } else {
          showError('Failed to initiate login. Please try again.');
        }
      } catch (error) {
        console.error('Login error:', error);
        showError('An error occurred during login.');
      }
    }
    
    // Check login status for regular web flow
    async function checkLoginStatus(token) {
      const checkStatus = async () => {
        try {
          const response = await fetch(`/api/telegram/status/${token}`);
          
          if (response.ok) {
            const statusData = await response.json();
            
            if (statusData.status === 'completed') {
              // Login successful
              userData = statusData.user;
              
              // Save user data to localStorage
              localStorage.setItem('telegramUser', JSON.stringify(userData));
              
              updateUI();
            } else if (statusData.status === 'pending') {
              // Still pending, check again in 2 seconds
              setTimeout(checkStatus, 2000);
            } else {
              showError('Login failed. Please try again.');
            }
          } else {
            showError('Login failed or expired. Please try again.');
          }
        } catch (error) {
          console.error('Status check error:', error);
          showError('An error occurred while checking login status.');
        }
      };
      
      // Start checking status
      setTimeout(checkStatus, 2000);
    }
  </script>
</body>
</html>